<!DOCTYPE html>
<html>
<head>
    <title>React avec ES6</title>
    <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="description" content="Formation React js, avec ES6"/>
    <meta name="keywords"
          content="formation react, formation reactjs, freelance, flux, redux, es6, props, state, jsx"/>
    <link rel="canonical" href="http://codox.fr/formation-reactjs-es6"/>
    <a href="https://google.com/+JeanBaptisteCazaux" rel="publisher"/>

    <style>
        @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
        @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
        @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

        body {
            font-family: 'Droid Serif';
        }

        table {
            border-collapse: collapse;
        }

        table th:nth-child(2), table tr td:nth-child(2) {
            background-color: #6fa8dc;
        }

        table th:nth-child(3), table tr td:nth-child(3) {
            background-color: #ea9999;
        }

        th, td {
            padding: 5px;
            border: 1px solid black;
        }

        img {
            max-width: 100%;
        }

        li {
            margin-bottom: .8em;
        }

        li:first-child {
            margin-top: .8em;
        }

        h1, h2, h3 {
            font-family: 'Yanone Kaffeesatz';
            font-weight: 400;
            margin-bottom: 0;
            margin-top: 10px;
        }

        h1 {
            font-size: 3.5em;
        }

        h2 {
            font-size: 3em;
        }

        h3 {
            font-size: 1.6em;
        }

        p {
            margin: .5em 0;
        }

        .inverse {
            background: #272822;
            color: #777872;
            text-shadow: 0 0 20px #333;
        }

        .inverse h1, .inverse h2 {
            color: #f3f3f3;
            line-height: 0.8em;
        }

        pre {
            border-left: 0.4em solid #d7d7d7;
            padding-left: 0.5em !important;
            margin-top: .5em;
            margin-bottom: 0;
        }

        code {
            background: transparent !important;
            padding-left: 0.2em !important;
        }

        a {
            color: #F92672;
            text-decoration: none;
        }

        .task {
            float: right;
            font-size: 0.9em;
            padding-top: 0.6em;
        }

        .task a {
            color: #080;
            text-decoration: none;
        }

        .right {
            float: right;
            margin-left: 1em;
        }

        .pushdown {
            margin-top: 12em;
        }

        .remark-code, .remark-inline-code {
            font-family: 'Ubuntu Mono';
        }

        @media print {
            .remark-slide-scaler {
                width: 100% !important;
                height: 100% !important;
                transform: scale(1) !important;
                top: 0 !important;
                left: 0 !important;
            }
        }
    </style>
</head>
<body>
<textarea id="source">

class: center, middle, inverse

# React
### avec ES6

#### [@jbcazaux](http://twitter.com/jbcazaux)
#### [http://codox.fr/formation-reactjs-es6](http://codox.fr/formation-reactjs-es6)


---
# Hello !
![mynameis](images/mynameis.jpg)
---
# Coffee breaks
![coffee](images/coffee.gif)
![hours](images/hours.gif)
---
# Objectifs personnels
![postits](images/postits.jpg)
---

## Versions

```json
"react": "15.6.1"
"create-react-app": "1.0.11"
```
---

# Contenu

* ES6
    * Quelques nouveautés
    * Rappels sur la programmation fonctionnelle
* ReactJS
    * Principes
    * Composants
    * Etats
    * Redux
    * Tests
    * Router
    * Optimisations
---

class: center, middle, inverse

# EcmaScript 6

---
template: default
layout: true

### EcmaScript 6

---

# ~~var~~, let, const

```javascript
let foo = 'bar';
const MAX = 10;
const ttc = addTva(15);
```

**let** vs. **const** ?
---

# ~~var~~, let, const
```javascript
let foo = 'bar';
const MAX = 10;
const ttc = addTva(15);
```

**let** vs. **const** ?

0 **var**, 44 **let**, 997 **const**

---

# ~~var~~, let, const

```javascript
if (true) {
    var i = 1;
} else {
    var j = 2;
}
console.log(i, j);
```
---

# ~~var~~, let, const

```javascript
const user = {};
user.name = 'john'; // (1)
user = {name: 'lea'}; // (2)
```
```javascript
const arr = ['a'];
arr.push('b'); // (3)
arr = ['a', 'b']; // (4)
```
---

# Arrow functions

```javascript
function addOldSchool(a, b) {
    return a + b;
}
```
---

# Arrow functions

```javascript
function addOldSchool(a, b) {
    return a + b;
}

let add = (a, b) => {
    return a + b;
}
```
---

# Arrow functions

```javascript
function addOldSchool(a, b) {
    return a + b;
}

let add = (a, b) => {
    return a + b;
}

add = (a, b) => a + b
```
---

# Arrow functions

```javascript
const squares = [0, 1, 2, 3, 4].map(x => x * x);
console.log(squares);
```
---

# Attention !

Pas totalement supporté par les navigateurs : [Tableau de compatibilité](http://www.webbrowsercompatibility.com/es6/desktop/)
* Shim (Array.map(), Array.reduce(), ...)
* Transpiler (=>, let, const, ...)
---

# Spread operator

```javascript
const odd = [1, 3, 5, 7, 9];
const even = [2, 4, 6, 8]
const all = [0];

// arr.push([element1[, ...[, elementN]]])
all.push(odd);
all.push(even);

console.log(all) // ?
```
---

# Spread operator

```javascript
const odd = [1, 3, 5, 7, 9];
const even = [2, 4, 6, 8]
const all = [0];

// arr.push([element1[, ...[, elementN]]])
for (let i = 0; i < odd.length; i++) {
    all.push(odd[i]);
}
for (let i = 0; i < even.length; i++) {
    all.push(even[i]);
}
console.log(all) // ?
```
---
# Spread operator

```javascript
const odd = [1, 3, 5, 7, 9];
const even = [2, 4, 6, 8]
const all = [0];

// arr.push([element1[, ...[, elementN]]])
all.push(...odd);
all.push(...even);

console.log(all) // ?
```
---
# Destructuring

```javascript
const foo = {a: 1, b: 2, c: 'bar'};
let {a} = foo;
console.log(a); // ?
```
---
# Destructuring

```javascript
const user = {
    firstname: 'john',
    nickname: 'ninja',
    lastname: 'doe',
    age: 21
};

function getUserName(user) {
    return user.firstname.concat(' ').concat(user.lastname);
}
console.log(getUserName(user));
```
---
# Destructuring

```javascript
const user = {
    firstname: 'john',
    nickname: 'ninja',
    lastname: 'doe',
    age: 21
};

function getUserName(user) {
    return user.firstname.concat(' ').concat(user.lastname);
}

function getUserName({firstname, lastname}) {
    return firstname.concat(' ').concat(lastname);
}
console.log(getUserName(user));
```
---
# Destructuring

```javascript
const user = {
    firstname: 'john',
    nickname: 'ninja',
    lastname: 'doe',
    age: 21
};

function getUserName(user) {
    return user.firstname.concat(' ').concat(user.lastname);
}

function getUserName({firstname, lastname}) {
    return firstname.concat(' ').concat(lastname);
}

const getUserName = ({firstname, lastname}) =>
    firstname.concat(' ').concat(lastname);

console.log(getUserName(user));
```
---
# Shorthand Notation
```javascript
const foo = 42;
const bar = 1;

const longer = {
    foo: foo,
    bar: bar
}
```
---
# Shorthand Notation
```javascript
const foo = 42;
const bar = 1;

const longer = {
    foo: foo,
    bar: bar
}

const shorter = {
    foo,
    bar
}
```

---

# Bonus

* Object.assign
```javascript
Object.assign({}, {a: 1, c: 3}, {a: 10, b: 2}); // = ?
```

* Map
```javascript
const m = new Map();
m.set('foo', 2);
const bar = m.has('foo') ? m.get('foo') : 0;
```

* Set
```javascript
const uniq = new Set([1, 2, 3, 1, 2, 3]);
uniq.length // ?
```
---
# Rappels - currying

```javascript
let add = function(x) {
    return function(y) {
        return x + y
    }
}
add(2)(3) // ???
```
---
# Rappels - currying

```javascript
let add = function(x) {
    return function(y) {
        return x + y
    }
}
add(2)(3) // 5 !

const add2 = add(2);
add2(3); // = ?
```

---
# Rappels - currying

```javascript
let add = function(x) {
    return function(y) {
        return x + y
    }
}
let add = x => y => x + y // WTF ?!
```
---
# Rappels - currying

```javascript
let add = function(x) {
    return function(y) {
        return x + y
    }
}
let add = x => y => x + y // WTF ?!

let add = x =>
    y => (x + y);
// easy !
```

---
# Rappels - this
```javascript
function f() {
    this.foo; // what is this ?
}
```
---

layout: false
class: center, middle, inverse

# React
---

template: default
layout: true

### Intro
---

# Tout est composant

![components](images/components.png)
---

#Hello world
index.js
```javascript
import React from "react";
import ReactDOM from "react-dom";
import Hello from "./Hello";

ReactDOM.render(
    <Hello name="cnrs"/>,
    document.getElementById('root')
);

```
Hello.js
```javascript
import React from "react";

class Hello extends React.Component {

    render() {
        return (
            <div>
                Hello {this.props.name} !
            </div>
        );
    }
}
export default Hello;
```
---

#JSX
```javascript
render: function() {
    return (
      <li className="contact">
          <h2 className="contact-name">{this.props.name}</h2>
      </li>
    )
}
```
ou pas:
```javascript
render: function() {
    return (
      React.createElement('li', {className: 'contact'},
        React.createElement('h2', {className: 'contact-name'},
                                            this.props.name)
      )
    )
}
```
---

#Create or extends ?
```javascript
const Hello = React.createClass({
    render: function() {
        return (
            <h1>Hello {this.props.name}!</h1>
        );
    }
});
```
```javascript
class Hello extends React.Component {
    render() {
        return (
            <h1>Hello {this.props.name}!</h1>
        );
    }
}
```

---
layout: false

#TP-01
## Hello World !

1. Etendre la classe React.Component
2. Implémenter la méthode render()

---
template: default
layout: true

### React.Component
---

# Type checking

On peut ne **rien** faire, utiliser **Typescript**, **Flow** ou les **PropTypes**.
```javascript
class Hello extends React.Component {

    static propTypes = {
        name: PropTypes.string.isRequired,
        truc: PropTypes.bool
    };

    render() {
        return (
            <h1>Hello {this.props.name}!</h1>
        );
    }
}

Hello.propTypes = {
    name: PropTypes.string.isRequired,
    truc: PropTypes.bool
}
```
Au choix: array, bool, func, number, object, string, symbol, node, instanceOf(MyObject),
oneOf['News', 'Photos'], oneOfType([...]), arrayOf(), objectOf()...

[https://www.npmjs.com/package/prop-types](https://www.npmjs.com/package/prop-types)

---

#Composant et Cycle de vie
Les incontournables:
* **render()**
* **componentWillMount()**
* **componentDidMount()**
* **componentWillUnmount()**

Les autres:
* **componentWillReceiveProps(**nextProps**)**
* **componentWillUpdate(**nextProps, nextState**)**
* **componentDidUpdate(**nextProps, nextState**)**
* **getInitialState()**
* **getDefaultProps()**
* **shouldComponentUpdate(**nextProps, nextState**)**

---

# State

* Définir l'état par défaut
```javascript
getInitialState() { return {...} }
```
```javascript
this.state = {...}
```
* Définir un nouvel état
```javascript
this.setState({...})
this.setState(prevState => {...})
```
* Récupérer l'état courant
```javascript
this.state
```

---

# Props vs State
* Props
    * Les données passées par les parents
* State
    * A faire
        * Les données modifiables par les événements de la UI
        * Le plus possible de composants sans état
    * A ne pas faire
        * Des données calculées (à faire dans render)
        * Des données dérivées des *props*
        * Des composants

---

#Stateless component
```javascript
import React from "react";

const Hello = (props) => <h1>Hello {props.name}!</h1>;
```

```javascript
class ButtonApp extends React.Component {
    render() {
        return <div>
            <div>{this.props.title}</div>
            <button>{this.props.label}</button>
        </div>
        }
}
const ButtonApp = (props) =>
    <div>
        <div>{props.title}</div>
        <button>{props.label}</button>
    </div>;

const ButtonApp = ({title, label}) =>
    <div>
        <div>{title}</div>
        <button>{label}</button>
    </div>;
````
---

template: default
layout: true

### Tips

---

# Itérer sur un tableau
```javascript
render() {
    return (
        ...
        {
            items.map(item => <div key={item.id}>{item.label}</div>)
        }
        ...
    )
}
```
---
layout: false

#TP-02
## Liste de courses
1. Afficher le titre passé par le parent
2. Mettre un état par défaut
3. Faire afficher la liste des courses dans des balises < li >
4. Afficher un message de log pour chaque moment du cycle de vie
5. Créer un composant distinct pour les éléments (li) de la liste
6. Bonus: Utiliser une classe qui encapsule le composant "liste" pour gérer l'appel au serveur, et transmettre les data
en tant que *props*
---
#Bonus TP-02
```javascript
class ShoppingList extends React.Component {
    // constructor...
    // componentDidMount() {...}
    render() {
        return (
            <ShoppingListInternal
                    title={this.props.title}
                    items={this.state.items}/>
        )
    }
}

const ShoppingListInternal = ({title, items}) => (
    <div>
        <h2>{title}</h2>
        <ul>
            {
                items.map(item => <ShoppingItem key={item.id} item={item}/>)
            }
        </ul>
    </div>
)
```
---

template: default
layout: true

### Callbacks

---

# Passer des fonctions dans Props
```javascript
class ShoppingList extends React.Component {
    // constructor...
    // componentDidMount() {...}
    deleteItem() {
        const newItems = this.state.items.slice(1);
        this.setState({...state, items: newItems});
    }
    render() {
        return (<ShoppingListInternal
                    title={this.props.title}
                    items={this.state.items}
                    del={this.deleteItem.bind(this)}/>)
    }
}
const ShoppingListInternal = ({title, items, del}) => (
    <div>
        <h2>{title}</h2>
        <ul>
            {items.map(item => {
                return (<li onClick={del}>
                        <span>{item.label}</span>:<span>{item.price}€</span>
                        </li>
                )})}
        </ul>
    </div>
);
```
---

template: default
layout: true

### Avec du style

---

#inline style vs css

Pourquoi pas du inline ?

```javascript
render() {
	const mystyle = {
		backgroundColor: '#F0ABCD'
	}
	return <div style={mystyle}/>
}
```
Sinon une CSS globale, ou une CSS par composant (Webpack powered)

```javascript
import './MyComponent.css';
```
---

#React-bootstrap
Adaptation des composants bootstrap à React
```javascript
<Button bsStyle="primary" onClick={this.handleClick.bind(this)}>Go!</Button>
```

La documentation
* [https://react-bootstrap.github.io/components.html](https://react-bootstrap.github.io/components.html)
* [http://getbootstrap.com/components/](http://getbootstrap.com/components/)

---

template: default
layout: true

### Tips

---
# Caractères spéciaux
```javascript
<span> Jet d{String.fromCharCode(39)}eau</span>
```

---

# JSX if (else)
if
```javascript
{this.state.user && <div>{this.state.user.login}</div>}
```
not
```javascript
{this.state.user || <div>No User</div>}
```
if-else
```javascript
{this.state.user ? <div>{this.state.user.login}</div> : <div>No User</div>}
```
---

# Children

```javascript
ReactDOM.render(
    <ButtonApp title="Mon Application">Press Me! </ButtonApp>,
    document.getElementById('root')
);
```
```javascript
export default class ButtonApp extends React.Component {
    render() {
        return <div>
            <div>{this.props.title}</div>
            <button>{this.props.children}</button>
        </div>
    }
};
```
---
layout: false

#TP-03
## Liste des étudiants
1. Installer react-bootstrap
2. Afficher un champ texte qui permet de filtrer les éléments d'un tableau
3. Afficher le nom de l'étudiant sur lequel on a cliqué, ou un message si aucun n'est sélectionné
4. Bonus ES6: Calculer de façon élégante la note max d'un élève (reduce)
---

# Rappels
* Un composant a des propriétés et des états
* Un composant stateless est plus maintenable et testable
* On ne peut passer des propriétés qu'aux enfants (ce n'est pas de l'héritage;) )

---
layout: false
class: center, middle, inverse

# Flux & Redux
---

template: default
layout: true

### Flux & Redux

---

# Flux

* Store: Stocker la donnée + Logique
* Action: Modifier le modèle
* Dispatcher: Répartir les actions dans les stores
* View: Les composants UI

![flux acton diagram](images/flux.png)

**Le flux ne va que dans un seul sens !** (~~2-way binding~~)

---

# Bad Practice vs. Good Practice

![best practices](images/flux-bestpractice.png)

* On ne met pas à jour directement les autres composants
* On passe par le store (redux), les stores (flux), les services (Subject RxJs), ...

---

# Redux

* Un store unique (pratique pour l'isomorphisme)
* L'état du store est read-only
* On émet des *actions* pour modifier l'état
* Les actions sont interprétées par des *reducers*
    * les *reducers* sont des fonctions *pures*
    * les *reducers* prennent en entrée l'état précédent et une action
    * ils retournent le nouvel état dans un objet immutable

![redux](images/redux.png)

---

# Actions


### Actions
```javascript
{type: 'INCREMENT', inc: 3}
{type: 'ADD_TODO', text: 'Acheter du pain'}
{type: 'SET_USER', user: new User(1, 'toto')}
```

### Action Creator
```javascript
export const incrementor = (inc) => {
    return {type: 'INCREMENT', inc};
};
```
```javascript
export const incrementor = (inc) => ({type: 'INCREMENT', inc});
```

![redux](images/redux.png)
---

# Reducer
```javascript
export const display =
(state = 0, action) => {
    switch (action.type) {
        case 'INCREMENT':
           return state + action.inc;
        case 'DECREMENT':
           return state - action.inc;
        default:
           return state;
    }
};
```
Le *state* est en read-only !
![redux](images/redux.png)
---

# Store
Deux méthodes importantes dans le store: **dispatch** et **getState**.

* Le *store* garde l'état de l'application. On y accède via *getState()*.
* ~~setState()~~ !! On modifie l'état en 'dispatchant' une action: *dispatch(inc(3))*

Il y a aussi **subscribe**
* On peut être prévenu des changements du store via *subscribe(listener)*
* On se désenregistre avec la méthode retournée par *subscribe*
* Mais on ne s'en sert jamais ;)

![redux](images/redux.png)

---
layout: false
class: center, middle, inverse

# React & Redux
---

template: default
layout: true

### React & Redux
---

# Composition de reducers - Approche naïve
```javascript
const initialState = {user: '', counter: 0};
export const myGlobalReducer =
(state = initialState, action) => {
    switch (action.type) {
        case 'SET_USER':
           return {...state, user: action.user};
        case 'INCREMENT':
           return {...state, counter: state.counter + 1};
        case 'DECREMENT':
           return {...state, counter: state.counter - 1};
        default:
           return state;
    }
};
```
Ca peut faire lourd sur une grosse appli...!

---

# Composition de reducers - Découpage
```javascript
export const user =
(state = User.NULL, action) => {
    switch (action.type) {
        case 'SET_USER':
           return action.user;
        default:
           return state;
    }
};
export const counter =
(state = 0, action) => {
    switch (action.type) {
        case 'INCREMENT':
           return state + 1;
        case 'DECREMENT':
           return state - 1;
        default:
           return state;
    }
};
```
---

# Composition de reducers - Effet Waouh
```javascript
const initialState = {user: 'nobody', counter: 0};
export const myGlobalReducer =
(state = initialState, action) => {
    return {
        user: user(state.user, action),
        counter: counter(state.counter, action)
    }
};
```
Et avec un peu de magie...
```javascript
import { combineReducers } from 'redux'
export const myGlobalReducer = combineReducers({
    user,
    counter
});
```
---

# Récapitulatif

- Actions
- Reducers
- Store
- Composants React
- Il reste à lier les composants au store !

![redux](images/redux.png)

---

# Présentation et Conteneur

* Les composants stateless sont simples à maintenir
* Séparation des responsabilités

![react-redux](images/conteneur-pres.png)

---

# Présentation et Conteneur

** On découpe nos composants (connectés au *store*) en 2, *présentation* & *conteneur* **

|               | Presentational Components         | Container Components                          |
| ------------- |-----------------------------------| ----------------------------------------------|
| Purpose	    |How things look (markup, styles)   | How things work (data fetching, state updates)|
| Aware of Redux| No	                            | Yes                                           |
| To read data  | Read data from props	            | Subscribe to Redux state                      |
| To change data| Invoke callbacks from props       | Dispatch Redux actions                        |
| Are written	| By hand                           | Usually generated by React Redux              |

---

# Connect

* Le composant de présentation est comme les composants simples rencontrés jusque là (sans appels ajax)
* Le composant conteneur va être généré automatiquement, ** mais **
    * il faut décrire comment créer les *props* à partir des données du *store*: **mapStateToProps(state: State): StateProps {...}**
    * il faut implémenter les callbacks qui seront injectés dans les *props*: **mapDispatchToProps(dispatch: Function): DispatchProps {...}**

```javascript
import {connect} from 'react-redux';

export const MyComponent =
    connect(mapStateToProps, mapDispatchToProps)(MyPresentationalComponent);
```
---

## Composant de présentation:
```javascript
export const SelectCodePostal_ = ({cps, currentCp, onSelectCp}) => (
    <select onChange={onSelectCp} value={currentCp}>
        {
            cps.map(cp => <option key={cp} value={cp}>{cp}</option> )
        }
    </select>
);
```
---

## Conteneur
```javascript
const mapStateToProps = (state) => {
    const cpsOfAgence = state.codesPostaux.map(cp => cp.id);
    return {cps: cpsOfAgence, currentCp: state.codePostal.id};
};

const mapDispatchToProps = (dispatch) => {
    return {
        onSelectCp: (event) => {
            const codePostalId =
                new CodePostalId(parseInt(event.target.value));
            dispatch({type: 'SET_CODE_POSTALID', cpId: codePostalId});
        }
    };
};
export const SelectCodePostal =
    connect(mapStateToProps, mapDispatchToProps)(SelectCodePostal_);
```
---

# Passer le store

Tous les conteneurs de l'application doivent avoir accès au store.
```javascript
import React from 'react';
import ReactDOM from 'react-dom';
import {Provider} from 'react-redux';
import {createStore} from 'redux';
import {reducer, State} from './reducers/index';
import {App} from './components/app';

const store = createStore(reducer);

ReactDOM.render(
    <Provider store={store}>
        <App/>
    </Provider>,
    document.getElementById('app')
);
```
---
layout: false

#TP-04
## Liste de courses - bis
1. Installer les packages redux et react-redux
2. Reprendre le TP-02 mais en utilisant le *state* du store plutot que le *state* du composant,
et en initialisant la liste sans chargement asynchrone (liste en dur).
 * Créer un *action creator* **setItems** qui renvoie une **ItemAction**
 * Créer un reducer **items** qui prend une **ItemAction** en entrée
 * Créer un reducer global à l'aide de **combineReducer**
 * Créer le *contener* et le *presentational component*
3. Bonus: Créer un bouton qui permet d'ajouter des items au store.

---

template: default
layout: true

### Actions asynchrones
---

## Généralités

* Redux ne permet que de dispatcher des objets
* **redux-thunk** ou **redux-saga** permettent de lancer une fonction, et donc des actions asynchrones ou des actions avec conditions.
Ce sont des **middlewares**.
* En redux-thunk, c'est plus élégant que les actions retournent des **promesses**

---

template: default
layout: true

### redux-thunk
---

## Configuration
```javascript
import {reducer} from './reducers/index';
import {createStore, applyMiddleware} from 'redux';
import thunk from 'redux-thunk';

const store = createStore(
    reducer,
    applyMiddleware(thunk)
);

```

---

## Promesses

```javascript
const getItemsId =
    () => axios.get('src/items.json')
        .then(resp => resp.data)
        .then(items => items.map(item => item.id))
        .catch(error => console.log(error.toString()))
```
```javascript
const getItemsId =
    () => fetch('src/items.json')
        .then(resp => resp.data)
        .then(items => items.map(item => item.id))
        .catch(error => console.log(error.toString()))
```

---

## ThunkActionCreator
```javascript
const INCREMENT_COUNTER = 'INCREMENT_COUNTER';

function incrementCreator(inc) {
  return {
    type: INCREMENT_COUNTER,
    inc: inc
  };
}

function incrementAsyncCreator(inc) {
  return dispatch => {
    setTimeout(() => {
      dispatch(incrementCreator(inc));
    }, 1000);
  };
}
```

---

## En 2 mots

Une **ThunkAction** est une fonction qui reçoit en entrée les méthodes *dispatch()* et *getState()*, et retourne le
résultat de **dispatch()**
---

```javascript
export const fetchItems = () =>
    (dispatch, getState) => getItems(getState().userId)
        .then(items => {
            dispatch(setItems(items));
        })
        .catch((error) => {
            console.log(error);
        });
```

---
layout: false

#TP-05
## Liste de courses - ter
1. Installer redux-thunk
2. Reprendre le TP-04 mais faisant un appel asynchrone (http) pour charger la liste d'items
3. Bonus: Faire une action qui avant d'ajouter l'item au store, applique la TVA sur le prix lors d'un ajout d'item par le formulaire

---

template: default
layout: true

### redux-saga
---

## Generators

```javascript
function* fooGenerator() {
    yield 'a';
    yield 'b';
    yield 42;
    return 'bye';
}

for (const val of fooGenerator()) {
    console.log(val);
}
```

---

## Generators

```javascript
function* fooGenerator() {
    yield 'a';
    yield 'b';
    yield 42;
    return 'bye';
}

for (const val of fooGenerator()) {
    console.log(val);
}

const it = fooGenerator();
console.log(it.next()); // Object {value: "a", done: false}
console.log(it.next()); // Object {value: "b", done: false}
console.log(it.next()); // Object {value: 42, done: false}
console.log(it.next()); // Object {value: "bye", done: true}
console.log(it.next()); // Object {value: undefined, done: true}

```
---

## Generators

```javascript
function* barGenerator() {
    const a = yield 'a';
    console.log('a', a);
    const b = yield 'b';
    console.log('b', b);
    const c = yield 'c';
    console.log(c);
    return 'good bye';
}
for (const val of barGenerator()) {
    console.log(val);
}
// output ?
```
---

## Generators

```javascript
function* qixGenerator(x) {
    const a = yield x + 1;
    console.log(a);
    return 'good bye';
}

const it = qixGenerator(5);
console.log(it.next()); // Object {value: 6, done: false}
console.log(it.next(100)); // ?

```
---

## Generators

```javascript
function* qixGenerator(x) {
    const a = yield x + 1;
    console.log(a);
    return 'good bye';
}

const it = qixGenerator(5);
console.log(it.next()); // Object {value: 6, done: false}
console.log(it.next(100)); // 100 - Object {value: "good bye", done: true}
```
---

## Sagas

```javascript
export function* loadItems() {
  const items = yield call(fetch, '/items');
  yield put({type: 'SET_ITEMS', items: items});
}

```

```javascript
export function* loadCharts(action) {
  const user = yield call(fetch, '/user/' + action.userId);
  if (user.isPremium()) {
    const data = yield call(fetchPremiumChartsData);
    yield put({type: 'SET_CHARTS_DATA', data: data});
  }
  else {
    const data = yield call(fetchBasicChartsData);
    yield put({type: 'SET_CHARTS_DATA', data});
  }
}

```
```javascript
export function* loadProducts() {
  try {
    const products = yield call(fetchProducts)
    yield put({ type: 'PRODUCTS_RECEIVED', products })
  }
  catch(error) {
    yield put({ type: 'PRODUCTS_REQUEST_FAILED', error })
  }
}
```

---

## Watch Sagas - takeEvery

```javascript
function* loadUser(action) {
    const user = yield call(fetchUser, action.userId);
    yield put(setUser(user));
};

const loadAgencies = function* (action) { // une autre façon d'écrire !
    const agencies = yield call(fetchAgencies, action.userId);
    const agenciesIds = agencies.map(a => a.id);
    yield put(setAgenciesIds(agenciesIds));
};

export default function* rootSaga() {
    yield all([
        takeEvery('LOAD_USER', loadUser),
        takeEvery('LOAD_AGENCIES', loadAgencies)
    ])
};
```
---

## Watch Sagas - take

```javascript
function* loadUser(action) {...}
function* loadAgencies(action) {...};

function* watchLoadUser() {
    while (true) {
        const action = yield take('LOAD_USERS');
        yield call(loadUser, action);
    }
}

function* watchLoadAgencies() {
    while (true) {
        const action = yield take('LOAD_AGENCIES');
        yield call(loadAgencies, action);
    }
}

export default function* rootSaga() {
    yield fork(watchLoadUser);
    yield fork(watchLoadAgencies);
}
```
---

## Configuration

```javascript
import React from "react";
import ReactDOM from "react-dom";
import {Provider} from 'react-redux';
import {applyMiddleware, createStore} from 'redux';
import createSagaMiddleware from 'redux-saga'
import {reducer} from './reducers/index';
import ShoppingList from './ShoppingList';
import rootSaga from './sagas/items';

const sagaMiddleware = createSagaMiddleware();
const store = createStore(reducer, applyMiddleware(sagaMiddleware));

sagaMiddleware.run(rootSaga); // GO !

ReactDOM.render(
    <Provider store={store}>
        <ShoppingList title="liste de courses"/>
    </Provider>,
    document.getElementById("root")
);
```

---

## Utilisations avancées

La course
```javascript
function* fetchPostsWithTimeout() {
  const {posts, timeout} = yield race({
    posts: call(fetch, '/posts', {method: 'get'}),
    timeout: call(delay, 1000)
  })

  if (posts) {
    put({type: 'SET_POSTS', posts});
  } else {
    put({type: 'TIMEOUT_ERROR'});
  }
}
```
---

## Utilisations avancées

Annuler une tâche
```javascript
function* main() {
  while ( yield take('START_DATE_SYNC')) {
    const task = yield fork(dateSync);
    yield take('STOP_DATE_SYNC')
    yield cancel(bgSyncTask)
  } // recommence à écouter 'START_DATE_SYNC'
}

function* dateSync() {
  try {
    while (true) {
      const d = yield call(fetchDate);
      yield put(setCurrentDate(d));
      yield call(delay, 1000);
    }
  } finally {
    if (yield cancelled()) {
      yield put(setCurrentDate(0));
    }
  }
}
```
---

## Utilisations avancées

Récupérer l'état du store
```javascript
function* loadFriends() {
  const currentUser = yield(select('user'));
  const friends = yield call(fetch, '/users/' + currentUser.id + '/friends');
  yield put({type: 'SET_FRIENDS', friends};
}
```
---

layout: false

#TP-05-02
## Liste de courses - ter
1. Installer redux-saga
2. Reprendre le TP-04 mais faisant un appel asynchrone (http) pour charger la liste d'items
3. Faire une saga qui avant d'ajouter l'item au store, applique la TVA sur le prix lors d'un ajout d'item par le formulaire

---

# Bravo !
* C'était la partie la plus compliquée
* On sait créer des composants et leur passer des propriétés
 * Depuis leur composant parent
 * Depuis depuis un l'état 'local' (**LocalState**)
 * Depuis l'état du **store** (**State**)
 * Depuis un composant grand(n)-parent par le context... ou pas !

---

template: default
layout: true

### Context
---

## Mises en garde

* On peut passer des objets à ses composants enfants (n'importe où dans la hiérarchie).
* Des librairies sont basées la dessus, mais ce n'est pas officiellement supporté (le fonctionnement pourra varier, être supprimé).
La doc parle d'**experimental API** !
* *react-redux* fonctionne grâce à ca (le store est passé à tous les enfants).
* ** A n'utiliser qu'en cas d'urgence ;)**

---

## PropTypes

* Permet de décrire (typer, rendre obligatoire, ...) des propriétés
* Nécessaires pour faire fonctionner le *context*

---

## Utilisation
Dans le composant parent, il faut implémenter *getChildContext()*
```javascript
getChildContext() {
    return {color: 'purple', user: new User(0, 'admin')};
}
```
Puis définir les *childContextTypes*, toujours dans le composant parent
```javascript
static childContextTypes = {
    color: PropTypes.string.isRequired,
    user: PropTypes.object.isRequired
};
```

---

## Utilisation
Dans le composant enfant, on peut typer le *context*, il faut déclarer les *contextTypes*, et là on
a accès au context dans le composant.
```javascript
class Child extends React.Component {

    context;

    static contextTypes = {
        color: PropTypes.string.isRequired,
        user: PropTypes.object.isRequired
    };

    render() {
        return <div>user = {this.context.user.login}</div>;
    }
}
```

---
layout: false

#TP-06
## Contexte
Le but est de passer une couleur et un **User** d'un composant à son composant 'petit-fils'
1. Déclarer un context dans le composant grand parent (Large), avec une couleur et un User.
2. Afficher les informations passées dans le *context* dans le composant petit-fils (Small)

---

template: default
layout: true

### Tests

---

## Jest & Enzyme

L'idée est de tester les composants de *présentation*, avec leurs états et leurs propriétés.

[Jest API](https://facebook.github.io/jest/docs/api.html#content)

[Enzyme API](https://github.com/airbnb/enzyme/blob/master/docs/api/shallow.md)

```javascript
import React from "react";
import {shallow} from "enzyme";

describe(MyComponent, () => {
    it('should work !', () => {
        const component = shallow(<MyComponent/>);
    });
});
```
---

## Quelques exemples

Vérifier que le composant s'affiche avec ses sous composants
```javascript
describe(MyComponent, () => {
    it('renders MyComponent and its sub components', () => {
        const component = shallow(
            <MyComponent/>
        );
        expect(component.find(SubComponent1).exists()).toBeTruthy();
        expect(component.find(SubComponent2).exists()).toBeTruthy();
    });
});
```
Vérifier le texte du composant
```javascript
expect(component.text()).toContain('mon texte attendu');
```

Vérifier qu'une méthode a été appelée
```javascript
const mockOnChange = jest.fn();
expect(mockOnChange).toBeCalledWith(myParam);
```
---

## Quelques exemples

Simuler un événement
```javascript
component.find('button').at(1).simulate('click');
component.find('input').simulate('change', {target: {value: 'ma valeur'}});
```
Appeler une méthode
```javascript
component.instance().maMethode();
```
Récupérer l'état
```javascript
expect(component.state('name')).toEqual('mon nom');
```
---
## Tests des sagas

L'idée est de tester unitairement les sagas, pas les méthodes appelées.
* Les embranchements conditionnels
* Les appels à put, call, fork, ...

```javascript
function* loadUser(action) {
    const user = yield call(fetch, '/users/' + action.userId);
    yield put({type: 'SET_USER', user});
}
```

```javascript
it('load user', () => {
        const gen = loadUser({userId: 42});

        expect(gen.next().value).toEqual(call(fetch, '/users/42'));
        const user = {id: 42, name: 'joe'};
        expect(gen.next(user).value).toEqual({type: 'SET_USER', user: user});
        expect(gen.next().done).toBeTruthy();
    });
```
---
layout: false

#TP-07
## Les tests
Le but est de tester complètement le TP-03
1. Installer enzyme et react-addons-test-utils (--save-dev)
2. Créer un fichier .test.js par composant
3. *StudentDetails*: Vérifier le texte pour les 2 cas (Student.NULL ou non)
4. *Filter*: Vérifier que le callback est appelé lors d'un événement *change*
5. *StudenstTable*: Vérifier le nombre de ligne du tableau suivant le nombre de *Student* passés. Vérifier également le callback.
6. *StudentsApp*: Vérifier que le composant et ses sous composants sont affichés, puis vérifier l'impact des méthodes *handleSelectStudent()* et
*handleFilterChange()* sur le *state*. Enfin valider que *filteredStudents()* renvoie les bons éléments pour un filtre donné.
7. (saga) Bonus: Reprendre le TP 05-02 et écrire les tests des sagas.
---
template: default
layout: true

### Router
---

## react-router

Il existe plusieurs systèmes de gestion de l'historique de navigation:
* **BrowserRouter** : /monsite/page1/partie2
* **HashRouter**: /monsite/#/page1/partie2
* **MemoryRouter** : /

Pour le BrowserRouter il faut modifier le serveur pour rediriger toutes les requêtes vers index.html, sauf les css, js, et appels aux webservices.
---

## react-router

Définir le Router au plus haut niveau dans l'application.

```javascript
import {BrowserRouter as Router, Route, Link} from 'react-router-dom';

ReactDOM.render(
    <Router>
        <Route exact path="/" component={Home}/>
        <Route path="/about" component={About}/>
        <Route path="/admin" component={Admin}/>
    </Router>,
    document.getElementById('root')
);
```
On peut imbriquer les routes !
```javascript
const Admin = () => (
    <div>
        <h2>Administration</h2>
        <Route path={'/admin/users'} component={UsersAdmin}/>
        <Route path={'/admin/articles'} component={ArticlesAdmin}/>
    </div>
)
```
---

## react-router

On peut générer des liens automatiquement (voir la doc pour les propriétés)
```javascript
<Link to="/admin/users">Administration des utilisateurs</Link>
```

---

## react-router

Urls dynamiques
```javascript
<Route path={'/admin/users/:userId'} component={UserAdmin}/>
```
```javascript
const UserAdmin = ({match}) => (
<div>
    Gérer l'utilisateur {match.params.userId}
</div>
)
```
---
layout: false

#TP-08
## React-router
Le but est de créer une application avec les routes /part1 et /part2. Une zone commune (App) persiste.
1. Installer react-router
2. Utiliser react-router dans l'index.js
3. react-router-redux ?

---
template: default
layout: true

### Optimisations
---

## Reconciliation

Le **Virtual DOM** est une réprésentation des composants en mémoire. Quand les propriétés d'un composant changent, le nouveau
DOM est comparé à l'ancien (celui du Virtual DOM). Si il y a une différence, le 'vrai' DOM est modifié.

Si on sait que le composant n'a pas besoin d'être redessiné, on peut surcharger *shouldComponentUpdate*
```javascript
shouldComponentUpdate(nextProps, nextState) {
  return true;
}
```

Faut-il étendre React.PureComponent (shallow equality) ou redéfinir la méthode equals ?
Dans tous les cas le mieux est de ne pas avoir des données mutables: Object.assign, spread properties, Immutable
---


## Memoization

Permet d'éviter le recalcul d'une propriété dérivée de l'état du store redux. Par exemple le tri d'une liste,
le caclcul du prix total d'un panier, ...

```javascript
const shopItemsSelector = state => state.shop.items;
const taxPercentSelector = state => state.shop.taxPercent;

const subtotalSelector = createSelector(
  shopItemsSelector,
  items => items.reduce((acc, item) => acc + item.value, 0)
)

const taxSelector = createSelector(
  subtotalSelector,
  taxPercentSelector,
  (subtotal, taxPercent) => subtotal * (taxPercent / 100)
)

export const totalSelector = createSelector(
  subtotalSelector,
  taxSelector,
  (subtotal, tax) => ({ total: subtotal + tax })
)

```

---

layout: false

#TP-09
## Optimisation
Jouer avec la méthode shouldComponentUpdate
1. Implémenter la méthode shouldComponentUpdate
2. Installer le plugin React, pour voir si le composant est redessiné

---
class: center, middle, inverse

# Let's do it !

#### help ? [jbcazaux@gmail.com](mailto:jbcazaux@gmail.com)
#### [http://codox.fr/formation-reactjs-es6](http://codox.fr/formation-reactjs-es6)


</textarea>
<script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
</script>
<script>
    var slideshow = remark.create({highlightLanguage: 'javascript'});
</script>
</body>
</html>
